name: Build and Release

on:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    - name: Restore NuGet packages
      run: nuget restore

    - name: Build Release version
      run: |
        msbuild /p:Configuration=Release /p:Platform="Any CPU"

    - name: Download ILRepack
      run: |
        curl -L -o ILRepack.zip https://github.com/gluck/il-repack/releases/download/2.1.0-beta1/ILRepack.2.1.0-beta1.zip
        7z x ILRepack.zip -oILRepack

    - name: Create single executable
      run: |
        .\ILRepack\ILRepack.exe /out:StudioBrightnessControl.exe /wildcards bin\Release\StudioBrightnessControl.exe bin\Release\*.dll

    - name: Verify output
      run: |
        echo "=== Final executable ==="
        dir StudioBrightnessControl.exe

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          # Studio Brightness Control ${{ github.ref_name }}
          
          单文件版本，包含所有依赖。
        files: StudioBrightnessControl.exe